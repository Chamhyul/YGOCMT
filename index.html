<!DOCTYPE html>
//Synapse ver. 0.8.1
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>YGO 시냅스 - 보유 카드 관리 시스템</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard@v1.3.9/dist/web/static/pretendard.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/css/materialize.min.css">
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
  <style>
    :root {
      --bg-body: #f4f7f6;
      --bg-surface: #ffffff;
      --bg-sub: #fafafa;
      --bg-header: #f5f5f5;
      --text-primary: #333333;
      --text-secondary: #666666;
      --text-muted: #9e9e9e;
      --primary-color: #009688;
      --primary-dark: #00796b;
      --border-color: #ddd;
      --error-red: #f44336;
      --success-green: #2e7d32;
      --warning-yellow: #fbc02d;
      --bg-success: #e0f2f1;
      --bg-fail: #ffebee;
      --input-bg: #ffffff;
      --disabled-bg: #e0e0e0;
      --disabled-text: #9e9e9e;
      --overlay-bg: rgba(255, 255, 255, 0.85);
      
      /* Navigation Colors (Default: Light Mode - Grey) */
      --nav-bg: #cfcfcf; 
      --nav-text: #424242;
      --nav-text-active: #009688;
      --nav-border: rgba(0, 0, 0, 0.1);
      --nav-shadow: 0 4px 15px rgba(0,0,0,0.1);
    }

    body.dark-mode {
      --bg-body: #121212;
      --bg-surface: #1e1e1e;
      --bg-sub: #252525;
      --bg-header: #2c2c2c;
      --text-primary: #e0e0e0;
      --text-secondary: #b0b0b0;
      --text-muted: #757575;
      --primary-color: #4db6ac;
      --primary-dark: #26a69a;
      --border-color: #424242;
      --error-red: #ef5350;
      --success-green: #66bb6a;
      --warning-yellow: #fdd835;
      --bg-success: #1b5e20;
      --bg-fail: #b71c1c;
      --input-bg: #2c2c2c;
      --disabled-bg: #424242;
      --disabled-text: #757575;
      --overlay-bg: rgba(0, 0, 0, 0.6);

      /* Navigation Colors (Dark Mode - Black) */
      --nav-bg: rgba(0, 0, 0, 0.85);
      --nav-text: #9e9e9e;
      --nav-text-active: #4db6ac;
      --nav-border: rgba(255, 255, 255, 0.1);
      --nav-shadow: 0 4px 20px rgba(0,0,0,0.5);
    }

    body, input, button, table, .btn, .modal-content, select { font-family: 'Pretendard', sans-serif !important; }
    body { background-color: var(--bg-body); color: var(--text-primary); transition: background-color 0.3s, color 0.3s; }
    
    /* --- Navigation Styles Start --- */
    .app-sidebar {
        position: fixed;
        left: 0; top: 0; bottom: 0;
        width: 240px;
        background-color: var(--nav-bg);
        z-index: 900;
        display: flex;
        flex-direction: column;
        padding-top: 80px;
        transition: width 0.3s ease, background-color 0.3s ease;
        box-shadow: 1px 0 0 var(--nav-border);
        backdrop-filter: blur(10px);
        -webkit-backdrop-filter: blur(10px);
    }

    .nav-item {
        display: flex;
        align-items: center;
        padding: 16px 24px;
        color: var(--nav-text);
        cursor: pointer;
        transition: background-color 0.2s, color 0.2s;
        text-decoration: none;
    }

    .nav-item:hover {
        background-color: rgba(128,128,128,0.1);
        color: var(--nav-text-active);
    }

    .nav-item i {
        margin-right: 16px;
        font-size: 24px;
    }

    .nav-text {
        font-size: 0.95rem;
        font-weight: 600;
        white-space: nowrap;
    }

    .mobile-nav-container {
        display: none;
        position: fixed;
        bottom: 24px; 
        left: 0; 
        right: 0;
        z-index: 1050;
        justify-content: center;
        align-items: flex-end;
        gap: 12px;
        pointer-events: none;
        padding: 0 16px;
    }

    .nav-capsule {
        display: flex;
        align-items: center;
        justify-content: space-around;
        background-color: var(--nav-bg);
        height: 64px;
        flex: 1;
        max-width: 320px;
        border-radius: 32px;
        box-shadow: var(--nav-shadow);
        backdrop-filter: blur(15px);
        -webkit-backdrop-filter: blur(15px);
        border: 1px solid var(--nav-border);
        pointer-events: auto;
        padding: 0 10px;
    }

    .nav-circle {
        display: flex;
        align-items: center;
        justify-content: center;
        background-color: var(--nav-bg);
        width: 64px;
        height: 64px;
        border-radius: 50%;
        box-shadow: var(--nav-shadow);
        backdrop-filter: blur(15px);
        -webkit-backdrop-filter: blur(15px);
        border: 1px solid var(--nav-border);
        pointer-events: auto;
        color: var(--nav-text);
        cursor: pointer;
        transition: color 0.2s, transform 0.1s;
    }
    
    .nav-circle:active { transform: scale(0.95); }

    .mobile-nav-item {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        color: var(--nav-text);
        font-size: 0.65rem;
        cursor: pointer;
        flex: 1;
        height: 100%;
        transition: color 0.2s;
        font-weight: 600;
        min-width: 48px;
    }
    
    .mobile-nav-item:hover, .mobile-nav-item:active { color: var(--nav-text-active); }
    .mobile-nav-item i { font-size: 24px; margin-bottom: 2px; }

    @media only screen and (min-width: 993px) { body { padding-left: 240px; } }
    @media only screen and (min-width: 601px) and (max-width: 992px) {
        body { padding-left: 72px; }
        .app-sidebar { width: 72px; }
        .nav-text { display: none; }
        .nav-item { justify-content: center; padding: 16px 0; }
        .nav-item i { margin-right: 0; }
    }
    @media only screen and (max-width: 600px) {
        body { padding-bottom: 100px; }
        .app-sidebar { display: none; }
        .mobile-nav-container { display: flex; }
        .header-right-container { top: 8px; }
        .container { max-width: 100% !important; padding: 0 15px; }
    }
    /* --- Navigation Styles End --- */

    .header-right-container {
        position: absolute; top: 8px; right: 12px;
        display: flex; align-items: center; 
        gap: 10px; 
        z-index: 10;
    }

    .theme-switch-wrapper { display: flex; align-items: center; gap: 8px; height: 18px !important; }
    #theme-label { font-size: 0.75rem; color: var(--text-muted); font-weight: 600; line-height: 1 !important; }
    
    .theme-switch { display: inline-block; position: relative; margin-bottom: 0; height: 18px !important; width: 36px !important; line-height: 1 !important; vertical-align: middle; }
    .theme-switch input { display: none; }
    
    .slider { background-color: #ccc; position: absolute; cursor: pointer; top: 0; left: 0; width: 36px; height: 18px; transition: .4s; border-radius: 34px; }
    .slider:before { background-color: white; content: ""; position: absolute; height: 14px; width: 14px; left: 2px; bottom: 2px; transition: .4s; border-radius: 50%; }
    input:checked + .slider { background-color: var(--primary-color); }
    input:checked + .slider:before { transform: translateX(18px); }
    
    /* [MODIFIED] Custom Region Dropdown Styles with Fixed Width */
    .region-container {
        position: relative;
        z-index: 1002;
        width: 88px; /* Fixed width reduced to fit Portuguese */
    }

    .region-capsule {
        display: flex; 
        align-items: center;
        /* justify-content: center; REMOVED */
        gap: 6px;
        background-color: var(--bg-surface);
        border: 1px solid var(--border-color);
        padding: 4px 6px; /* Adjusted padding */
        border-radius: 24px;
        box-shadow: 0 1px 2px rgba(0,0,0,0.05);
        height: 30px; 
        box-sizing: border-box;
        cursor: pointer;
        transition: border-radius 0.1s, box-shadow 0.2s;
    }
    
    .region-capsule.active {
        border-radius: 12px 12px 0 0; 
        box-shadow: 0 4px 10px rgba(0,0,0,0.1);
        border-bottom: 1px solid transparent; 
    }

    .region-icon { color: var(--text-muted); font-size: 1rem; flex-shrink: 0; }
    
    .region-text {
        color: var(--text-primary); 
        font-size: 0.75rem; 
        font-weight: 700; 
        white-space: nowrap;
        user-select: none;
        flex: 1; /* Added: Take remaining space */
        text-align: center; /* Added: Center text in remaining space */
    }

    .region-dropdown-list {
        display: none;
        position: absolute;
        top: 100%; right: 0; left: 0;
        background-color: var(--bg-surface);
        border: 1px solid var(--border-color);
        border-top: 1px solid #eee;
        border-radius: 0 0 12px 12px;
        box-shadow: 0 4px 10px rgba(0,0,0,0.1);
        list-style: none;
        margin: 0;
        padding: 5px 0;
        width: 100%; /* Match container width */
        z-index: 1003;
        text-align: center; /* Center align text */
    }
    
    body.dark-mode .region-dropdown-list { border-top: 1px solid #444; }

    .region-dropdown-list li {
        padding: 8px 0;
        font-size: 0.8rem;
        color: var(--text-primary);
        cursor: pointer;
        white-space: nowrap;
    }
    
    .region-dropdown-list li:hover { background-color: var(--bg-sub); color: var(--primary-color); font-weight: 700; }

    .container { margin-top: 30px; max-width: 95% !important; }
    
    .app-title-container {
        display: flex; flex-direction: column; align-items: center; justify-content: center;
        margin-top: 60px; margin-bottom: 25px; text-align: center; line-height: 1;
    }
    .title-ygo { font-size: 1rem; font-weight: 700; color: var(--text-primary); letter-spacing: 2px; opacity: 0.8; margin-bottom: 0; z-index: 1; }
    .synapse-logo-container { display: flex; justify-content: center; align-items: center; margin: 0; width: 100%; }
    .synapse-logo-svg { width: 100%; max-width: 220px; height: auto; }
    .title-beta { font-size: 0.85rem; font-weight: 700; color: var(--error-red); letter-spacing: 3px; margin-top: 0; }
    
    .search-box { padding: 0; margin-bottom: 20px; background: transparent; box-shadow: none; display: flex; flex-direction: column; align-items: center; position: relative; }
    .search-header-row { width: 100%; max-width: 700px; margin: 0 auto 5px auto; display: flex; justify-content: flex-start; padding-left: 5px; }

    /* [MODIFIED] Help Button Icon Position & Hover Color */
    .help-trigger-btn {
        font-size: 0.75rem; font-weight: 600; color: var(--text-muted); cursor: pointer;
        display: flex; align-items: center; gap: 4px; transition: color 0.2s;
        height: 18px !important; line-height: 1 !important;
    }
    /* Restored to -1px to align with text center */
    .help-trigger-btn i { font-size: 0.8rem; transform: translateY(-1px); }
    /* Hover color changed to Main Color (Cyan) */
    .help-trigger-btn:hover { color: var(--primary-color); }

    .search-row { display: flex; align-items: center; justify-content: center; width: 100%; max-width: 700px; gap: 8px; }
    
    .search-input-wrapper { 
        flex: 1; position: relative; background: var(--bg-surface); border: 1px solid var(--border-color);
        border-radius: 24px; padding: 0; box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        transition: border-radius 0.2s ease, box-shadow 0.2s ease; z-index: 1001;
    }
    .search-input-wrapper.active { border-radius: 24px 24px 0 0; box-shadow: 0 4px 10px rgba(0,0,0,0.1); border-bottom: 1px solid transparent; }

    #search-btn { border-radius: 50px !important; width: 80px; height: 45px; padding: 0; display: flex; align-items: center; justify-content: center; flex-shrink: 0; }

    input#card-search { 
        text-align: left !important; font-size: 1.1rem; padding-left: 20px !important; padding-right: 40px !important;
        box-sizing: border-box; color: var(--text-primary); border-bottom: none !important; box-shadow: none !important;
        height: 46px !important; margin: 0 !important; width: 100%; display: block;
    }
    input#card-search::placeholder { color: var(--text-muted); }
    body.dark-mode ::placeholder { color: #757575 !important; }
    
    .clear-search-btn { 
        position: absolute; right: 15px; top: 50%; transform: translateY(-50%); cursor: pointer; 
        color: rgba(0,0,0,0.25); display: none; z-index: 5; transition: color 0.2s;
    }
    .clear-search-btn:hover { color: rgba(0,0,0,0.6); }
    body.dark-mode .clear-search-btn { color: rgba(255,255,255,0.25); }
    body.dark-mode .clear-search-btn:hover { color: rgba(255,255,255,0.7); }

    .btn.cyan-theme { background-color: var(--primary-color) !important; font-weight: 600; color: #fff; }
    
    .custom-dropdown {
      position: absolute; top: 100%; left: -1px; right: -1px; 
      background-color: var(--bg-surface); border: 1px solid var(--border-color); border-top: 1px solid #eee; 
      border-radius: 0 0 24px 24px; z-index: 1000; max-height: 250px; overflow-y: auto; display: none;
      box-shadow: 0 4px 10px rgba(0,0,0,0.1); margin: 0; padding: 5px 0 10px 0; list-style: none;
    }
    body.dark-mode .custom-dropdown { border-top: 1px solid #444; }

    .custom-dropdown li {
      padding: 8px 20px; cursor: pointer; border-bottom: none; font-size: 0.95rem; color: var(--text-primary);
      display: block; white-space: normal; transition: background-color 0.1s;
    }
    .custom-dropdown li:hover, .custom-dropdown li.active { background-color: var(--bg-sub); }
    .custom-dropdown li.text-suggest { color: var(--primary-color) !important; font-weight: 700 !important; }
    .custom-dropdown li .text-match { color: var(--text-primary) !important; font-weight: 400 !important; }
    .custom-dropdown li.no-result-item { font-style: italic; color: var(--text-muted) !important; cursor: default; pointer-events: none; font-weight: 400 !important; text-align: center; padding: 15px; }

    .dropdown-header { display: flex !important; align-items: center; justify-content: space-between !important; padding: 8px 15px !important; background-color: var(--bg-header) !important; cursor: default !important; }
    .dropdown-label { font-size: 0.75rem; color: var(--text-muted); font-weight: 600; }
    .delete-icon { cursor: pointer; color: var(--text-muted); font-size: 1.1rem; transition: color 0.2s; }
    .delete-icon:hover { color: var(--error-red); }

    .recent-header-item { display: flex !important; align-items: center; justify-content: space-between !important; padding: 8px 20px !important; cursor: default !important; margin-bottom: 5px; }
    .recent-header-item:hover { background-color: transparent !important; }
    .recent-title { font-size: 0.8rem; color: var(--text-muted); font-weight: 600; }
    .clear-all-btn { font-size: 0.8rem; color: var(--text-muted); cursor: pointer; text-decoration: underline; }
    .clear-all-btn:hover { color: var(--error-red); }

    .recent-item-row { display: flex !important; align-items: center; justify-content: space-between !important; }
    .recent-text { flex: 1; }
    .item-delete-btn { color: var(--text-muted); font-size: 1rem; padding: 4px; cursor: pointer; display: flex; align-items: center; }
    .item-delete-btn:hover { color: var(--error-red); }

    .url-input-container { position: relative; display: flex; align-items: center; margin-top: 20px; margin-bottom: 5px; }
    .url-input-container input { margin-bottom: 0 !important; padding-right: 40px !important; color: var(--text-primary); border-bottom: 1px solid var(--text-muted) !important; }
    .valid-icon { position: absolute; right: 10px; top: 50%; transform: translateY(-50%); display: none; }
    .status-msg { font-size: 0.85rem; font-weight: 600; margin-bottom: 20px; min-height: 1.2rem; }
    
    .guide-btn { cursor: pointer; color: var(--primary-dark); font-size: 1rem; font-weight: 700; margin-bottom: 12px; display: flex; align-items: center; gap: 4px; }
    .guide-btn i { transition: transform 0.2s; } 
    .guide-btn.active i { transform: rotate(90deg); }
    .guide-content { background: var(--bg-sub); padding: 18px; border-radius: 8px; font-size: 0.95rem; border: 1px solid var(--border-color); display: none; margin-bottom: 15px; color: var(--text-primary); }
    body.dark-mode .guide-content { color: #b0b0b0; }

    table { background: var(--bg-surface); font-size: 0.85rem; table-layout: fixed; width: 100%; border-collapse: collapse; color: var(--text-primary); }
    th { background: var(--bg-header); color: var(--text-secondary); font-weight: 700; padding: 10px 4px; text-align: center; border: 1px solid var(--border-color); font-size: 0.8rem; word-break: break-all; }
    td { border: 1px solid var(--border-color); text-align: center; padding: 6px 4px; position: relative; word-break: break-all; color: var(--text-primary); }
    
    .result-container th { background: var(--primary-color); color: white; border-color: var(--primary-dark); }
    .col-card-no { width: 180px; } .col-loc { width: 110px; } .col-total { width: 60px; } .col-proc { width: 70px; } 
    .expand-btn { cursor: pointer; color: var(--primary-color); position: absolute; right: 4px; top: 50%; transform: translateY(-50%); font-size: 1.3rem; }
    
    .sub-row { width: 100%; max-width: 800px; display: flex; justify-content: flex-start; align-items: flex-start; margin-top: 5px; min-height: 20px; } 
    
    .modal { border-radius: 12px; width: 95% !important; max-width: 600px !important; background-color: var(--bg-surface); color: var(--text-primary); }
    .modal .modal-content { background-color: var(--bg-surface); }
    .modal .modal-footer { background-color: var(--bg-surface); border-top: 1px solid var(--border-color); }
    #settings-modal .modal-footer { border-top: none !important; }
    #add-result-modal { width: 95% !important; max-width: 1000px !important; }
    
    #loading-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--overlay-bg); z-index: 11000; flex-direction: column; align-items: center; justify-content: center; backdrop-filter: blur(2px); }
    body.dark-mode #loading-text { color: var(--primary-color) !important; }
    
    #result-area { overflow-x: auto; max-height: 0; opacity: 0; transition: max-height 0.6s ease; width: 100%; margin-top: 30px; }
    #result-area.show { max-height: 10000px; opacity: 1; }

    .new-card-box { margin-bottom: 20px; border: 1px solid var(--border-color); border-radius: 8px; overflow: hidden; background: var(--bg-surface); box-shadow: 0 1px 3px rgba(0,0,0,0.05); }

    .summary-split-wrapper { display: flex; width: 100%; }
    .summary-left { width: 40%; background-color: var(--primary-color); color: white; font-weight: 700; font-size: 1rem; display: flex; align-items: center; justify-content: center; border-right: 1px solid var(--border-color); border-bottom: 1px solid var(--border-color); text-align: center; padding: 10px; }
    .summary-right { width: 60%; }
    
    .summary-table { width: 100%; border-collapse: collapse; font-size: 0.9rem; }
    .summary-table td { border: 1px solid var(--border-color); border-left: none; padding: 10px; text-align: center; color: var(--text-primary); }
    .summary-table tr:first-child td { border-top: none; }
    
    .border-double-top { border-top: 3px double var(--border-color) !important; background-clip: padding-box; position: relative; z-index: 1; }
    .summary-label-cell { background-color: var(--bg-sub); color: var(--text-secondary); font-weight: 600; width: 50%; }
    .summary-value-cell { width: 50%; font-weight: 500; }
    
    .show-more-btn { width: 100%; background-color: var(--bg-sub); color: var(--primary-dark); font-weight: 600; padding: 8px 0; border: none; border-top: 1px solid var(--border-color); cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 5px; transition: background-color 0.2s; }
    .show-more-btn:hover { background-color: var(--border-color); }
    body.dark-mode .show-more-btn { color: var(--primary-color); }
    
    .detail-slide-wrapper { max-height: 0; overflow-y: hidden; overflow-x: auto; transition: max-height 0.4s ease-in-out; border-top: none; }

    .split-table-wrapper { display: flex; width: 100%; border-top: 1px solid var(--border-color); }
    .fixed-side { width: 40%; flex-shrink: 0; border-right: 1px solid var(--border-color); background-color: var(--bg-surface); z-index: 2; }
    .scroll-side { width: 60%; overflow-x: auto; }
    
    .split-table { width: 100%; border-collapse: collapse; table-layout: fixed; }
    .split-table th { background-color: var(--bg-sub); color: var(--text-secondary); font-weight: 600; padding: 8px 4px; font-size: 0.85rem; border-top: none !important; border-left: none !important; border-bottom: 1px solid var(--border-color); border-right: 1px solid var(--border-color); white-space: nowrap; height: 35px; box-sizing: border-box; }
    .split-table td { padding: 8px 4px; font-size: 0.85rem; border-top: none !important; border-left: none !important; border-bottom: 1px solid var(--border-color); border-right: 1px solid var(--border-color); white-space: nowrap; height: 35px; box-sizing: border-box; text-align: center; color: var(--text-primary); }
    .split-table th:last-child, .split-table td:last-child { border-right: none; }

    .fp-col-1 { width: 37.5%; } .fp-col-2 { width: 37.5%; } .fp-col-3 { width: 25%; } .sp-col { width: 80px; }

    .material-tooltip { margin-top: 10px !important; text-align: center !important; line-height: 1.2 !important; }

    tr.success-row { background-color: var(--bg-success); } tr.fail-row { background-color: var(--bg-fail); }
    body.dark-mode tr.success-row { background-color: rgba(76, 175, 80, 0.2); } 
    body.dark-mode tr.fail-row { background-color: rgba(244, 67, 54, 0.2); } 
    
    .btn-flat-action { background-color: transparent !important; color: var(--text-secondary) !important; font-weight: 600; box-shadow: none !important; border: 1px solid var(--border-color); }
    .btn-flat-action:hover { background-color: var(--bg-header) !important; }

    /* New Intro and Footer Styles */
    #intro-area { text-align: center; color: var(--text-secondary); margin-top: 40px; margin-bottom: 40px; line-height: 1.8; font-size: 0.95rem; }
    #intro-area a { color: var(--primary-color); font-weight: 700; text-decoration: underline; cursor: pointer; }
    
    #main-footer { text-align: center; color: var(--text-muted); font-size: 0.8rem; margin-top: 50px; padding-bottom: 30px; }
    /* [MODIFIED] Footer text spacing */
    .footer-text { margin: 2px 0; color: var(--text-muted); line-height: 1.3; }
    
    /* [MODIFIED] Footer Disclaimer word break logic */
    .footer-disclaimer { margin-bottom: 12px; color: var(--text-muted); font-size: 0.85rem; }
    .footer-disclaimer span { display: inline-block; } /* Forces break at comma if needed */

    /* [MODIFIED] Maker link style */
    #main-footer a.maker-link { color: var(--text-muted); text-decoration: none; display: inline-flex; align-items: center; gap: 4px; transition: color 0.2s; }
    #main-footer a.maker-link:hover { color: #f44336; }
  </style>
</head>
<body>

<aside class="app-sidebar">
    <a class="nav-item">
        <i class="material-icons">search</i>
        <span class="nav-text">검색</span>
    </a>
    <a class="nav-item" onclick="checkAuthAndOpen('#add-card-modal')">
        <i class="material-icons">library_add</i>
        <span class="nav-text">카드 등록</span>
    </a>
    <a class="nav-item" onclick="checkAuthAndOpen('#manage-card-modal')">
        <i class="material-icons">import_export</i>
        <span class="nav-text">카드 이동</span>
    </a>
    <a class="nav-item" onclick="checkAuthAndOpen('#discard-card-modal')">
        <i class="material-icons">delete_outline</i>
        <span class="nav-text">카드 폐기</span>
    </a>
    <a class="nav-item" onclick="openSettingsWithGuide()">
        <i class="material-icons">link</i>
        <span class="nav-text">시트 연결</span>
    </a>
</aside>

<div class="mobile-nav-container">
    <div class="nav-capsule">
        <div class="mobile-nav-item" onclick="openSettingsWithGuide()">
            <i class="material-icons">link</i>
            <span>설정</span>
        </div>
        <div class="mobile-nav-item" onclick="checkAuthAndOpen('#add-card-modal')">
            <i class="material-icons">library_add</i>
            <span>등록</span>
        </div>
        <div class="mobile-nav-item" onclick="checkAuthAndOpen('#manage-card-modal')">
            <i class="material-icons">import_export</i>
            <span>이동</span>
        </div>
        <div class="mobile-nav-item" onclick="checkAuthAndOpen('#discard-card-modal')">
            <i class="material-icons">delete_outline</i>
            <span>폐기</span>
        </div>
    </div>
    <div class="nav-circle" onclick="">
        <i class="material-icons">search</i>
    </div>
</div>

<div class="header-right-container">
    <div class="theme-switch-wrapper">
        <span id="theme-label">다크 모드</span>
        <label class="theme-switch" for="checkbox-theme">
            <input type="checkbox" id="checkbox-theme" onchange="toggleTheme()">
            <div class="slider"></div>
        </label>
    </div>

    <div class="region-container">
        <div id="region-capsule" class="region-capsule" onclick="toggleRegionDropdown(event)">
            <i class="material-icons region-icon">public</i>
            <span id="region-text" class="region-text">한국</span>
        </div>
        <ul id="region-dropdown" class="region-dropdown-list">
            <li onclick="selectRegion('ko', '한국')">한국</li>
            <li onclick="selectRegion('ja', '일본')">일본</li>
            <li onclick="selectRegion('ae', '아시아')">아시아</li>
            <li onclick="selectRegion('cn', '중국')">중국</li>
            <li onclick="selectRegion('en', '영미')">영미</li>
            <li onclick="selectRegion('de', '독일')">독일</li>
            <li onclick="selectRegion('fr', '프랑스')">프랑스</li>
            <li onclick="selectRegion('it', '이탈리아')">이탈리아</li>
            <li onclick="selectRegion('es', '스페인')">스페인</li>
            <li onclick="selectRegion('pt', '포르투갈')">포르투갈</li>
        </ul>
    </div>
</div>

<div id="loading-overlay">
  <div class="preloader-wrapper big active"><div class="spinner-layer spinner-teal-only"><div class="circle-clipper left"><div class="circle"></div></div><div class="gap-patch"><div class="circle"></div></div><div class="circle-clipper right"><div class="circle"></div></div></div></div>
  <p id="loading-text" style="margin-top: 20px; font-weight: bold; color: var(--dark-cyan);">데이터 로드 중...</p>
</div>

<div class="container">
  <div class="app-title-container">
      <span class="title-ygo">유희왕</span>
      <div class="synapse-logo-container">
        <svg id="_레이어_1" data-name="레이어_1" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 120 30" class="synapse-logo-svg">
          <defs>
            <linearGradient id="grad-1" data-name="무제 그라디언트 43" x1="4.14" y1="15" x2="115.86" y2="15" gradientUnits="userSpaceOnUse">
              <stop offset="0" stop-color="var(--primary-color)" stop-opacity="0"/>
              <stop offset=".38" stop-color="var(--primary-color)" stop-opacity=".2"/>
              <stop offset=".9" stop-color="var(--primary-color)" stop-opacity=".6"/>
            </linearGradient>
            <linearGradient id="grad-2" data-name="무제 그라디언트 43" x1="115.86" x2="4.14" y2="15" xlink:href="#grad-1">
                <stop offset="0" stop-color="var(--primary-color)" stop-opacity="0"/>
                <stop offset=".38" stop-color="var(--primary-color)" stop-opacity=".2"/>
                <stop offset=".9" stop-color="var(--primary-color)" stop-opacity=".6"/>
            </linearGradient>
          </defs>
          <g id="bg_x5F_group">
            <polygon id="bg_x5F_down" points="115.86 25.59 4.14 4.41 4.14 25.59 115.86 25.59" fill="url(#grad-1)"/>
            <polygon id="bg_x5F_up" points="4.14 4.41 115.86 25.59 115.86 4.41 4.14 4.41" fill="url(#grad-2)"/>
          </g>
          <g id="title" fill="var(--text-primary)">
            <path d="M12.79,10.17c-1.4,0-2.05.55-2.07,1.33-.02.83.74,1.29,2.25,1.61l1.33.28c3.5.76,5.06,2.46,5.06,4.97,0,3.18-2.44,4.99-6.54,4.97-4.21.02-6.95-1.82-7-5.8h4.1c.07,1.5,1.1,2.28,2.81,2.3,1.47-.02,2.25-.62,2.25-1.47,0-.78-.67-1.24-2.48-1.66l-1.61-.37c-2.88-.6-4.65-2.03-4.65-4.56,0-3.06,2.72-5.13,6.53-5.11,3.91-.02,6.35,2.07,6.4,5.25h-4.14c-.07-1.1-.78-1.75-2.25-1.75Z"/>
            <path d="M24.57,6.86l3.27,6.67h.14l3.22-6.67h4.79l-5.98,11.09v5.2h-4.23v-5.2l-5.98-11.09h4.79Z"/>
            <path d="M51.62,23.15h-3.59l-6.03-8.79h-.09v8.79h-4.28V6.86h3.64l5.94,8.79h.14V6.86h4.28v16.29Z"/>
            <path d="M53.31,23.15l5.38-16.29h5.84l5.38,16.29h-4.6l-.97-3.18h-5.48l-.97,3.18h-4.6ZM63.37,16.76l-1.68-5.52h-.14l-1.68,5.52h3.5Z"/>
            <path d="M71.64,6.86h6.9c3.66.02,6.03,2.3,6.03,5.75s-2.44,5.64-6.17,5.66h-2.48v4.88h-4.28V6.86ZM77.57,14.92c1.61,0,2.53-.9,2.53-2.3s-.92-2.3-2.53-2.3h-1.66v4.6h1.66Z"/>
            <path d="M92.82,10.17c-1.4,0-2.05.55-2.07,1.33-.02.83.74,1.29,2.25,1.61l1.33.28c3.5.76,5.06,2.46,5.06,4.97,0,3.18-2.44,4.99-6.53,4.97-4.21.02-6.95-1.82-7-5.8h4.1c.07,1.5,1.1,2.28,2.81,2.3,1.47-.02,2.26-.62,2.26-1.47,0-.78-.67-1.24-2.49-1.66l-1.61-.37c-2.88-.6-4.65-2.03-4.65-4.56,0-3.06,2.71-5.13,6.54-5.11,3.91-.02,6.35,2.07,6.4,5.25h-4.14c-.07-1.1-.78-1.75-2.25-1.75Z"/>
            <path d="M101.71,6.86h11.6v3.5h-7.32v2.95h6.72v3.45h-6.72v2.95h7.32v3.45h-11.6V6.86Z"/>
          </g>
        </svg>
      </div>
      <span class="title-beta">BETA</span>
  </div>
  
  <div class="search-box">
    <div class="search-header-row">
        <div class="help-trigger-btn" onclick="openSettingsWithGuide()">
            <i class="fas fa-question-circle"></i>
            <span>사용법</span>
        </div>
    </div>
    <div class="search-row">
        <div class="search-input-wrapper" id="search-wrapper">
            <input type="text" id="card-search" autocomplete="off" placeholder="">
            <i id="clear-btn" class="material-icons clear-search-btn" onmousedown="event.preventDefault()">cancel</i>
            <ul id="custom-dropdown" class="custom-dropdown"></ul>
        </div>
        <button id="search-btn" class="btn waves-effect waves-light cyan-theme" onclick="startSearch()"><i class="material-icons">search</i></button>
    </div>
    <div class="sub-row"></div>
  </div>

  <div id="intro-area">
    <p>본 서비스는 실물 유희왕 카드의 체계적인 관리를 위해 제작됐습니다.<br>
    사용자가 보유한 카드의 정보는 직접 등록해야 합니다.<br>
    자세한 사용법은 <a onclick="openSettingsWithGuide()">[사용법]</a>을 확인하세요.</p>
  </div>

  <div class="result-container"><div id="result-area"></div></div>

  <footer id="main-footer">
    <p class="footer-disclaimer">
        <span>사용자가 입력한 모든 정보는 사용자가 등록한 구글 시트 파일에 기록되며,</span>
        <span>해당 내용은 서버에 저장되지 않습니다.</span>
    </p>
    <p class="footer-text">ver. 0.8.1 | Made by <a href="https://www.youtube.com/@참혈" target="_blank" class="maker-link"><i class="fab fa-youtube"></i> 참혈</a></p>
    <p class="footer-text">© 2025 YGO Synapse. All rights reserved.</p>
  </footer>
</div>

<div id="manage-card-modal" class="modal">
  <div class="modal-content">
    <h5 style="font-weight: 800; margin-bottom: 10px;">카드 이동</h5>
    <span class="modal-subtitle">카드의 보관 장소를 변경할 수 있습니다.</span>
    <div style="overflow-x: auto;">
      <table class="add-modal-table">
        <thead>
            <tr>
                <th style="width: 5%;">No</th>
                <th style="width: 20%;">카드 이름</th>
                <th style="width: 12%;">카드 번호</th>
                <th style="width: 10%;">어나더</th>
                <th style="width: 10%;">레어도</th>
                <th style="width: 13%;">보관 위치</th>
                <th style="width: 18%;">이동 위치</th>
                <th style="width: 8%;">보관 수량</th>
                <th style="width: 9%;">이동 수량</th>
            </tr>
        </thead>
        <tbody id="manage-card-tbody"></tbody>
      </table>
    </div>
    <div style="margin-top: 20px; text-align: center;"><button class="btn-flat waves-effect" onclick="addManageRows()" style="color: var(--primary-color); font-weight: 700;">더 많은 카드를 이동하시나요?</button></div>
  </div>
  <div class="modal-footer"><button class="btn-flat modal-close" style="color: var(--text-primary);">취소</button><button id="manage-submit-btn" class="btn cyan-theme" onclick="submitManageCards()">이동</button></div>
</div>

<div id="discard-card-modal" class="modal">
  <div class="modal-content"><h5 style="font-weight: 800; margin-bottom: 20px;">카드 폐기</h5><p class="center" style="color: var(--text-muted); margin-top: 50px;">서비스 준비 중입니다.</p></div>
  <div class="modal-footer"><button class="btn-flat modal-close" style="color: var(--text-primary);">닫기</button></div>
</div>

<div id="settings-modal" class="modal">
  <div class="modal-content">
    <h5 style="font-weight: 800; margin-bottom: 10px;">사용법 및 연결</h5>
    <p style="color: var(--text-secondary); line-height: 1.5; margin-bottom: 20px;">이 앱은 구글 시트를 기반으로 사용자가 보유한 카드를 등록하여, 실물 카드 관리를 보조합니다.<br>양식에 맞는 구글 시트 링크를 입력해주세요.</p>
    <div class="guide-btn" id="guide-accordion-btn" onclick="toggleGuide()"><i class="material-icons">keyboard_arrow_right</i><span>양식 다운로드 및 연결법</span></div>
    <div id="guide-box" class="guide-content"><ol><li><a href="https://docs.google.com/spreadsheets/d/16AVBIJvass2Zl6f4IwMpK5KcZkPOuGATWfo0FIdeOdw/copy" target="_blank" style="color: var(--primary-color); font-weight: 800; text-decoration: underline;">링크</a>를 눌러 양식 시트를 구글 드라이브에 복사합니다.</li><li>해당 파일을 <b>링크가 있는 모든 사용자 / 편집자</b>로 공유 설정을 변경합니다.</li><li>해당 파일의 공유 링크를 입력 후 확인을 눌러주세요.</li></ol></div>
    <div class="url-input-container"><input type="text" id="sheet-url" placeholder="https://docs.google.com/spreadsheets/d/..." oninput="validateSheetLink()"><div id="valid-mark" class="valid-icon"></div></div>
    <div id="status-msg" class="status-msg"></div>
  </div>
  <div class="modal-footer" style="display: flex; justify-content: space-between; padding: 0 24px 20px 24px; align-items: center; height: auto;">
    <button id="disconnect-btn" class="btn red darken-1 waves-effect waves-light" onclick="disconnectSheet()">연결 끊기</button>
    <div><button class="btn-flat modal-close" style="color: var(--text-primary);">취소</button><button id="confirm-btn" class="btn cyan-theme waves-effect waves-light disabled" onclick="saveSettings()">연결</button></div>
  </div>
</div>

<div id="add-card-modal" class="modal">
  <div class="modal-content">
    <h5 style="font-weight: 800; margin-bottom: 10px;">카드 등록</h5>
    <span class="modal-subtitle">원하는 카드를 등록할 수 있습니다.</span>
    <div style="overflow-x: auto;">
      <table class="add-modal-table">
        <thead>
            <tr>
                <th style="width: 5%;">No</th>
                <th style="width: 20%;">카드 이름</th>
                <th style="width: 15%;">카드 번호</th>
                <th style="width: 15%;">어나더 <i class="material-icons tiny tooltipped" data-position="top" data-tooltip="공식DB의 순서를 따릅니다." style="cursor:pointer; vertical-align: middle; color:var(--text-muted);">help_outline</i></th>
                <th style="width: 13%;">레어도</th>
                <th style="width: 12%;">보관 위치</th>
                <th style="width: 8%;">수량</th>
                <th style="width: 12%;">조정</th>
            </tr>
        </thead>
        <tbody id="add-card-tbody"></tbody>
      </table>
    </div>
    <div style="margin-top: 20px; text-align: center;"><button class="btn-flat waves-effect" onclick="addMoreRows()" style="color: var(--primary-color); font-weight: 700;">더 많은 카드를 등록할 건가요?</button></div>
  </div>
  <div class="modal-footer">
    <button class="btn-flat modal-close" style="color: var(--text-primary);">취소</button>
    <span class="tooltipped-wrapper tooltipped" data-position="top" data-tooltip="등록할 수 있는 카드가 없습니다.">
        <button id="add-submit-btn" class="btn cyan-theme disabled" onclick="submitNewCards()">등록</button>
    </span>
  </div>
</div>

<div id="add-result-modal" class="modal">
  <div class="modal-content">
    <div class="result-icon-area"><i class="material-icons">check_circle</i></div>
    <h5 style="font-weight: 800; text-align: center; margin-bottom: 20px;">카드 등록 완료!</h5>
    <p id="result-success-text" class="result-summary"></p>
    <p id="result-fail-text" class="result-fail-summary"></p>
    <div id="result-summary-table-box"><table class="result-table"><tbody id="result-summary-body"></tbody></table></div>
    <div class="toggle-result-btn" onclick="toggleResultDetail()"><span>자세히</span><i id="toggle-icon" class="material-icons" style="font-size:1.2rem; transform: translateY(1px);">keyboard_arrow_down</i></div>
    <div id="result-detail-box" class="result-detail-wrapper">
        <table class="result-table">
            <thead><tr><th style="width:10%;">No</th><th style="width:20%;">카드 이름</th><th style="width:15%;">카드 번호</th><th style="width:15%;">어나더</th><th style="width:15%;">레어도</th><th style="width:15%;">보관 위치</th><th style="width:10%;">수량</th></tr></thead>
            <tbody id="result-detail-body"></tbody>
        </table>
    </div>
  </div>
  <div class="modal-footer" style="display:flex; justify-content:flex-end; padding-right:24px; gap:8px;">
    <button class="btn cyan-theme modal-close">확인</button>
  </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/js/materialize.min.js"></script>
<script>
  const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbx2W7ZnDz-5gTTyIr6VxG8IbvkaPW-qZwRxmgXgfwpJ9hwPic9J1dh5ymDqxriCKuCI/exec";
  const STORAGE_KEY = 'yugioh_spreadsheet_id';
  const RECENT_KEY = 'recent_card_searches';
  const THEME_KEY = 'yugioh_theme_mode';
  const REGION_KEY = 'yugioh_region_setting';

  let allProcessingTypes = [], allNames = [], allLocations = [], localCardDatabase = [], rarityMap = {}, clientCache = {}, nameDb = {};
  let rarityMappingRaw = []; 
  let rarityLookup = {}; 
  let cidLookup = {}; 
  let isAppConfigured = false, acInstance = null, isLoading = false, validationTimeout = null;
  let hasRegisteredInSession = false;
  let isContinuingRegistration = false;
  let blurTimer = null;
  let currentRegion = 'ko';

  let currentFocus = -1;

  document.addEventListener('DOMContentLoaded', function() {
    loadTheme();
    loadRegion();
    checkClearBtn(); 

    const modals = document.querySelectorAll('.modal');
    modals.forEach(modal => {
        let options = {
            onCloseEnd: function(el) { 
                if(el.id === 'add-card-modal') {
                    if (hasRegisteredInSession) location.reload();
                    else if(!el.dataset.keepData) resetAddModal();
                    else delete el.dataset.keepData; 
                }
                if(el.id === 'manage-card-modal') resetManageModal(); 
                if(el.id === 'add-result-modal') {
                    location.reload(); 
                }
            } 
        };
        
        if (modal.id === 'add-result-modal') {
            options.dismissible = false; 
        }
        
        M.Modal.init(modal, options);
    });

    M.Tooltip.init(document.querySelectorAll('.tooltipped'));
    
    // FAB Logic Removed
    
    const searchInput = document.getElementById('card-search');
    
    const handleFocusOrClick = () => {
        if (!localStorage.getItem(STORAGE_KEY)) {
            searchInput.blur();
            openGuideFromMain();
            return;
        }
        const val = searchInput.value.trim();
        if (!val) {
            showRecentInDropdown();
        } else {
            filterAndShowDropdown(searchInput.value); 
        }
    };
    
    searchInput.addEventListener('click', handleFocusOrClick);
    searchInput.addEventListener('focus', handleFocusOrClick);
    
    searchInput.addEventListener('input', (e) => {
        const val = e.target.value;
        if (!val) {
            showRecentInDropdown();
            // [MODIFIED] Show Intro if search cleared
            document.getElementById('intro-area').style.display = 'block';
            document.getElementById('result-area').classList.remove('show');
            document.getElementById('result-area').innerHTML = '';
        }
        else filterAndShowDropdown(val);
        checkClearBtn(); 
    });
    
    // [MODIFIED] Use 'mousedown' & Inline Logic for Clear All (Fix for Safari IME issue)
    const dropdown = document.getElementById('custom-dropdown');
    dropdown.addEventListener('mousedown', function(e) {
        e.preventDefault(); // Prevents blur & input commit

        const target = e.target;

        // 1. Clear All Handler (Inline Logic Restored)
        if (target.classList.contains('clear-all-btn')) {
            localStorage.removeItem(RECENT_KEY);
            showRecentInDropdown();
            return;
        }

        // 2. Single Item Delete Handler
        if (target.classList.contains('item-delete-btn') || target.closest('.item-delete-btn')) {
            const delBtn = target.classList.contains('item-delete-btn') ? target : target.closest('.item-delete-btn');
            const li = delBtn.closest('li');
            if (li && li.dataset.val) {
                deleteRecentItem(li.dataset.val);
            }
            return;
        }

        // 3. Selection Handler
        const li = target.closest('li');
        if (li && !li.classList.contains('recent-header-item') && !li.classList.contains('no-result-item')) {
            const val = li.dataset.val;
            if (val) {
                document.getElementById('card-search').value = val;
                checkClearBtn();
                startSearch();
            }
        }
    });

    searchInput.addEventListener('keydown', function(e) { 
        let list = document.getElementById('custom-dropdown');
        if (list.style.display === 'none') return;
        
        // Get valid items (exclude header and no-result message)
        let items = list.querySelectorAll('li:not(.recent-header-item):not(.no-result-item)');
        
        if (e.keyCode == 40) { // Down
            currentFocus++;
            addActive(items);
        } else if (e.keyCode == 38) { // Up
            currentFocus--;
            addActive(items);
        } else if (e.keyCode == 13) { // Enter
            e.preventDefault();
            
            let targetVal = this.value; // Default to current input

            // If dropdown is open and has items
            if (list.style.display !== 'none' && items.length > 0) {
                let activeIndex = currentFocus > -1 ? currentFocus : 0; // Default to 0 if none selected
                if (items[activeIndex]) {
                    targetVal = items[activeIndex].dataset.val;
                }
            }

            // Update input and search
            if (targetVal) {
                this.value = targetVal;
            }
            this.blur();
            startSearch();
        }
    });

    function addActive(items) {
        if (!items) return false;
        removeActive(items);
        if (currentFocus >= items.length) currentFocus = 0;
        if (currentFocus < 0) currentFocus = items.length - 1;
        items[currentFocus].classList.add("active");
        items[currentFocus].scrollIntoView({ block: 'nearest', inline: 'start' });
    }

    function removeActive(items) {
        for (let i = 0; i < items.length; i++) {
            items[i].classList.remove("active");
        }
    }
    
    searchInput.addEventListener('blur', () => {
        blurTimer = setTimeout(() => {
            document.getElementById('custom-dropdown').style.display = 'none';
            toggleSearchWrapper(false); 
        }, 200);
    });

    document.getElementById('clear-btn').addEventListener('click', function() { 
        if(blurTimer) clearTimeout(blurTimer); 
        searchInput.value = ''; 
        this.style.display = 'none'; 
        searchInput.focus(); 
        showRecentInDropdown();
        // [MODIFIED] Restore Intro on clear
        document.getElementById('intro-area').style.display = 'block';
        document.getElementById('result-area').classList.remove('show');
        document.getElementById('result-area').innerHTML = '';
    });
    
    // Close Region Dropdown on outside click
    document.addEventListener('click', function(e) {
        const regionContainer = document.querySelector('.region-container');
        if (!regionContainer.contains(e.target)) {
            document.getElementById('region-dropdown').style.display = 'none';
            document.getElementById('region-capsule').classList.remove('active');
        }
    });

    updateDisconnectBtn(); refreshInitialData();
  });

  function checkClearBtn() {
      const val = document.getElementById('card-search').value;
      const btn = document.getElementById('clear-btn');
      btn.style.display = val ? 'block' : 'none';
  }

  function openSettingsWithGuide() {
      M.Modal.getInstance(document.getElementById('settings-modal')).open();
      toggleGuide(true);
  }

  function toggleSearchWrapper(isOpen) {
      const wrapper = document.getElementById('search-wrapper');
      if(isOpen) wrapper.classList.add('active');
      else wrapper.classList.remove('active');
  }

  function decomposeHangul(str) {
      const CHO = ['ㄱ','ㄲ','ㄴ','ㄷ','ㄸ','ㄹ','ㅁ','ㅂ','ㅃ','ㅅ','ㅆ','ㅇ','ㅈ','ㅉ','ㅊ','ㅋ','ㅌ','ㅍ','ㅎ'];
      const JUNG = ['ㅏ','ㅐ','ㅑ','ㅒ','ㅓ','ㅔ','ㅕ','ㅖ','ㅗ','ㅘ','ㅙ','ㅚ','ㅛ','ㅜ','ㅝ','ㅞ','ㅟ','ㅠ','ㅡ','ㅢ','ㅣ'];
      const JONG = ['','ㄱ','ㄲ','ㄳ','ㄴ','ㄵ','ㄶ','ㄷ','ㄹ','ㄺ','ㄻ','ㄼ','ㄽ','ㄾ','ㄿ','흐','ㅁ','ㅂ','ㅄ','ㅅ','ㅆ','ㅇ','ㅈ','ㅊ','ㅋ','ㅌ','ㅍ','ㅎ'];
      let result = "";
      for (let i = 0; i < str.length; i++) {
          const charCode = str.charCodeAt(i);
          if (charCode >= 0xAC00 && charCode <= 0xD7A3) {
              const code = charCode - 0xAC00;
              const choIndex = Math.floor(code / 588);
              const jungIndex = Math.floor((code % 588) / 28);
              const jongIndex = code % 28;
              result += CHO[choIndex] + JUNG[jungIndex] + JONG[jongIndex];
          } else {
              result += str.charAt(i);
          }
      }
      return result;
  }

  function normalizeStr(str) { return str.replace(/\s+/g, '').toLowerCase(); }

  // [MODIFIED] Partial Update Logic (No Child Handlers)
  function showRecentInDropdown() {
      const recent = JSON.parse(localStorage.getItem(RECENT_KEY) || '[]');
      const list = document.getElementById('custom-dropdown');
      
      currentFocus = -1; 

      // 1. Clean existing items EXCEPT the header
      Array.from(list.children).forEach(child => {
          if (!child.classList.contains('recent-header-item')) {
              child.remove();
          }
      });
      
      // 2. Ensure Header exists
      let header = list.querySelector('.recent-header-item');
      if (!header) {
          header = document.createElement('li');
          header.className = 'recent-header-item';
          header.innerHTML = `
            <span class="recent-title">최근 검색</span>
            <span class="clear-all-btn">전체 제거</span>
          `;
          list.prepend(header); 
      }

      // 3. Append new items
      if (recent.length === 0) {
          const noResultLi = document.createElement('li');
          noResultLi.className = 'no-result-item';
          noResultLi.innerText = '검색 기록이 없습니다.';
          list.appendChild(noResultLi);
      } else {
          recent.slice(0, 5).forEach(r => {
              const li = document.createElement('li');
              li.className = 'recent-item-row';
              li.dataset.val = r; 
              
              const textSpan = document.createElement('span');
              textSpan.className = 'recent-text text-suggest';
              textSpan.innerText = r;
              
              const delBtn = document.createElement('i');
              delBtn.className = 'material-icons item-delete-btn';
              delBtn.innerText = 'close';
              
              li.appendChild(textSpan);
              li.appendChild(delBtn);
              
              list.appendChild(li);
          });
      }
      
      list.style.display = 'block';
      toggleSearchWrapper(true);
  }

  function filterAndShowDropdown(val) {
      if(!isAppConfigured) return;
      const list = document.getElementById('custom-dropdown');
      const normalizedInput = normalizeStr(val);
      const decomposedInput = decomposeHangul(normalizedInput); 
      currentFocus = -1; 
      
      let matches = allNames.filter(name => {
          const normName = normalizeStr(name);
          const decompName = decomposeHangul(normName); 
          return decompName.includes(decomposedInput);
      });

      matches.sort((a, b) => {
          const normVal = normalizedInput;
          const normA = normalizeStr(a);
          const normB = normalizeStr(b);

          if (normA === normVal) return -1;
          if (normB === normVal) return 1;

          const aStarts = normA.startsWith(normVal);
          const bStarts = normB.startsWith(normVal);
          if (aStarts && !bStarts) return -1;
          if (!aStarts && bStarts) return 1;

          return a.length - b.length || a.localeCompare(b);
      });
      
      list.innerHTML = '';

      if (matches.length === 0) {
          list.innerHTML = '<li class="no-result-item">등록되지 않은 카드</li>';
          list.style.display = 'block';
          toggleSearchWrapper(true);
          return;
      }
      
      matches.slice(0, 10).forEach(m => {
          const li = document.createElement('li');
          li.className = 'text-suggest'; 
          li.dataset.val = m;
          
          let html = "";
          let searchIdx = 0;
          const lowerM = m.toLowerCase();
          const lowerVal = val.toLowerCase().replace(/\s+/g, ''); 
          
          for(let i=0; i<m.length; i++) {
              if(searchIdx < lowerVal.length && lowerM[i] === lowerVal[searchIdx]) {
                  html += `<span class="text-match">${m[i]}</span>`;
                  searchIdx++;
              } else {
                  html += m[i];
              }
          }
          
          li.innerHTML = html;
          list.appendChild(li);
      });
      list.style.display = 'block';
      toggleSearchWrapper(true);
  }

  function deleteRecentItem(name) {
      let recent = JSON.parse(localStorage.getItem(RECENT_KEY) || '[]');
      recent = recent.filter(r => r !== name);
      localStorage.setItem(RECENT_KEY, JSON.stringify(recent));
      showRecentInDropdown();
  }

  // [REMOVED] Function call removed as logic is now inline
  // function clearAllHistory() { ... }

  function updateDisconnectBtn() { const btn = document.getElementById('disconnect-btn'); if (localStorage.getItem(STORAGE_KEY)) btn.classList.remove('disabled'); else btn.classList.add('disabled'); }
  function toggleGuide(forceOpen = null) { 
      const btn = document.getElementById('guide-accordion-btn'); 
      const box = document.getElementById('guide-box'); 
      const isOpen = (forceOpen !== null) ? forceOpen : box.style.display === 'none'; 
      box.style.display = isOpen ? 'block' : 'none'; 
      if (isOpen) btn.classList.add('active'); else btn.classList.remove('active'); 
  }
  function openGuideFromMain() { M.Modal.getInstance(document.getElementById('settings-modal')).open(); toggleGuide(true); }
  
  function loadTheme() {
    const savedTheme = localStorage.getItem(THEME_KEY);
    if (savedTheme === 'dark') {
      document.body.classList.add('dark-mode');
      document.getElementById('checkbox-theme').checked = true;
    }
  }
  function toggleTheme() {
    if (document.getElementById('checkbox-theme').checked) {
      document.body.classList.add('dark-mode');
      localStorage.setItem(THEME_KEY, 'dark');
    } else {
      document.body.classList.remove('dark-mode');
      localStorage.setItem(THEME_KEY, 'light');
    }
  }

  // [MODIFIED] New Region Logic using Custom Dropdown with "Asia" update
  const regionMap = {
      'ko': '한국', 'ja': '일본', 'ae': '아시아', 'cn': '중국', 
      'en': '영미', 'de': '독일', 'fr': '프랑스', 'it': '이탈리아', 
      'es': '스페인', 'pt': '포르투갈'
  };

  function loadRegion() {
    const savedRegion = localStorage.getItem(REGION_KEY) || 'ko';
    currentRegion = savedRegion;
    document.getElementById('region-text').innerText = regionMap[savedRegion];
  }

  function toggleRegionDropdown(event) {
      event.stopPropagation();
      const list = document.getElementById('region-dropdown');
      const capsule = document.getElementById('region-capsule');
      
      if (list.style.display === 'block') {
          list.style.display = 'none';
          capsule.classList.remove('active');
      } else {
          list.style.display = 'block';
          capsule.classList.add('active');
      }
  }

  function selectRegion(code, text) {
      currentRegion = code;
      localStorage.setItem(REGION_KEY, code);
      document.getElementById('region-text').innerText = text;
      document.getElementById('region-dropdown').style.display = 'none';
      document.getElementById('region-capsule').classList.remove('active');
      // No reload needed if only rarity display logic changes, but reload is safer for full UI update
      // location.reload(); 
      // Or just adjust width if necessary, though current capsule is auto-width
  }

  // No longer needed adjustRegionWidth as it is flex container now
  function changeRegion() {
      // Legacy function kept if called elsewhere, but logic moved to selectRegion
  }

  // FAB update function removed

  async function callApi(action, params = {}, postData = null) {
    const url = new URL(SCRIPT_URL); url.searchParams.append("action", action);
    const savedId = localStorage.getItem(STORAGE_KEY); if (savedId) url.searchParams.append("ssId", savedId);
    for (const key in params) { url.searchParams.append(key, params[key]); }
    const options = { method: postData ? 'POST' : 'GET' }; if (postData) options.body = JSON.stringify(postData);
    const response = await fetch(url, options); return await response.json();
  }
  function checkAuthAndOpen(modalId) {
    if (!localStorage.getItem(STORAGE_KEY)) { 
        openGuideFromMain();
        return; 
    }
    if (modalId === '#manage-card-modal' && document.getElementById('manage-card-tbody').children.length === 0) addManageRows(1);
    if (modalId === '#add-card-modal' && document.getElementById('add-card-tbody').children.length === 0) addMoreRows(1);
    M.Modal.getInstance(document.querySelector(modalId)).open();
  }
  function resetAddModal() { document.getElementById('add-card-tbody').innerHTML = ''; addMoreRows(1); }
  function resetManageModal() { document.getElementById('manage-card-tbody').innerHTML = ''; addManageRows(1); }
  function validateSheetLink() { clearTimeout(validationTimeout); const url = document.getElementById('sheet-url').value.trim(); const mark = document.getElementById('valid-mark'), msg = document.getElementById('status-msg'), confirmBtn = document.getElementById('confirm-btn'); if (!url) { mark.style.display = 'none'; msg.innerText = ''; confirmBtn.classList.add('disabled'); return; } const match = url.match(/[-\w]{25,}/); if (!match) { mark.innerHTML = '<i class="material-icons" style="color: var(--error-red)">cancel</i>'; mark.style.display = 'block'; msg.innerText = '구글 시트 링크를 적어주세요.'; msg.style.color = 'var(--error-red)'; confirmBtn.classList.add('disabled'); return; } validationTimeout = setTimeout(async () => { msg.innerText = '권한 확인 중...'; try { const res = await callApi('checkSheet', { targetId: match[0] }); if (res.status === 'OK') { mark.innerHTML = '<i class="material-icons" style="color: var(--success-green)">check_circle</i>'; msg.innerText = '유효한 시트입니다.'; msg.style.color = 'var(--success-green)'; confirmBtn.classList.remove('disabled'); } else { mark.innerHTML = '<i class="material-icons" style="color: var(--warning-yellow)">warning</i>'; msg.innerText = (res.status === 'NO_EDIT_ACCESS') ? '공유 설정을 링크를 가진 모든 사용자 / 편집자로 설정해주세요.' : '접근할 수 없거나 형식이 잘못되었습니다.'; msg.style.color = 'var(--warning-yellow)'; confirmBtn.classList.add('disabled'); } mark.style.display = 'block'; } catch (e) { msg.innerText = '확인 실패'; } }, 500); }
  
  async function refreshInitialData() { 
    const savedId = localStorage.getItem(STORAGE_KEY); if (!savedId) return; 
    showLoading(true, "데이터 동기화 중..."); 
    try { 
      const res = await callApi('getInitialData'); 
      showLoading(false); 
      isAppConfigured = res.isConfigured; 
      if (res.isConfigured) { 
        allNames = res.names; 
        allProcessingTypes = res.processingTypes; 
        allLocations = res.locations; 
        localCardDatabase = res.allCards; 
        rarityMap = res.rarityMap || {}; 
        rarityMappingRaw = res.rarityMappingRaw || []; 
        clientCache = res.clientCache || {};
        nameDb = res.nameDb || {};

        cidLookup = {};
        Object.keys(nameDb).forEach(nameKey => {
            const entry = nameDb[nameKey];
            if (entry && entry.id) {
                if (!cidLookup[entry.id]) cidLookup[entry.id] = new Set();
                cidLookup[entry.id].add(nameKey);
            }
        });

        const expandedSet = new Set(allNames); 
        allNames.forEach(name => {
            const entry = nameDb[name];
            if (entry && entry.id) {
                const siblings = cidLookup[entry.id];
                if (siblings) {
                    siblings.forEach(sName => expandedSet.add(sName));
                }
            }
        });
        allNames = Array.from(expandedSet).sort();

        rarityLookup = {};
        rarityMappingRaw.forEach((row, index) => {
            Object.values(row).forEach(val => {
                const key = String(val).trim();
                if(key) {
                    rarityLookup[key] = { data: row, index: index };
                }
            });
        });
      } 
    } catch (e) { showLoading(false); } 
  }

  function startSearch() { 
    if (!localStorage.getItem(STORAGE_KEY)) {
        openGuideFromMain();
        return;
    }
    const name = document.getElementById('card-search').value; 
    if(!name || !isAppConfigured) return; 
    
    saveRecentSearch(name); 
    
    let targetNames = new Set();
    if (nameDb[name] && nameDb[name].id) {
        const cid = nameDb[name].id;
        if (cidLookup[cid]) {
            targetNames = cidLookup[cid];
        } else {
            targetNames.add(name);
        }
    } else {
        targetNames.add(name);
    }

    const filteredRows = localCardDatabase.filter(row => targetNames.has(String(row[0]))); 
    
    renderTable(filteredRows); 
    
    document.getElementById('custom-dropdown').style.display = 'none';
    toggleSearchWrapper(false);
    checkClearBtn(); 
  }
  
  function findMappingRow(key) {
      if (!rarityMappingRaw || rarityMappingRaw.length === 0) return null;
      return rarityMappingRaw.find(row => Object.values(row).includes(key));
  }

  function getLocalizedRarity(key) {
      if (!key) return "";
      const info = rarityLookup[key];
      if (info && info.data[currentRegion]) {
          return info.data[currentRegion];
      }
      return key;
  }

  function renderTable(rows) {
    showLoading(false); 
    const resultArea = document.getElementById('result-area');
    
    // [MODIFIED] Hide intro area
    document.getElementById('intro-area').style.display = 'none';

    if (rows.length === 0) { 
        resultArea.innerHTML = "<p class='center'>결과 없음</p>"; 
        resultArea.classList.add('show'); 
        return; 
    }

    const groups = {};
    rows.forEach(r => {
      const cardNo = String(r[1]), proc = String(r[2]), qty = parseInt(r[3]) || 0, loc = String(r[4]), another = String(r[5] || "").trim();
      if (!groups[cardNo]) groups[cardNo] = { locations: {}, anotherGroups: {} };
      if (!groups[cardNo].locations[loc]) groups[cardNo].locations[loc] = { total: 0, procs: {} };
      groups[cardNo].locations[loc].total += qty; groups[cardNo].locations[loc].procs[proc] = (groups[cardNo].locations[loc].procs[proc] || 0) + qty;
      if (another) { const aKey = `${another}|${loc}`; if (!groups[cardNo].anotherGroups[aKey]) groups[cardNo].anotherGroups[aKey] = { another, loc, total: 0, procs: {} }; groups[cardNo].anotherGroups[aKey].total += qty; groups[cardNo].anotherGroups[aKey].procs[proc] = (groups[cardNo].anotherGroups[aKey].procs[proc] || 0) + qty; }
    });
    
    let newHtml = "";
    Object.keys(groups).forEach(cardNo => {
        const rowId = `row-${cardNo}`.replace(/[^a-zA-Z0-9]/g, '');
        const cardRows = rows.filter(r => String(r[1]) === cardNo);
        
        const totalQty = cardRows.reduce((sum, r) => sum + (parseInt(r[3]) || 0), 0);
        const locSet = new Set(cardRows.map(r => String(r[4])).filter(l => l));
        
        const distinctKeys = [...new Set(cardRows.map(r => String(r[2]).trim()).filter(k => k))];

        distinctKeys.sort((a, b) => {
            const infoA = rarityLookup[a];
            const infoB = rarityLookup[b];
            
            const idxA = infoA ? infoA.index : 999999;
            const idxB = infoB ? infoB.index : 999999;
            
            return idxA - idxB || a.localeCompare(b);
        });
        
        const displayNamesForSummary = [...new Set(distinctKeys.map(k => rarityMap[k] || k))];
        const procStr = displayNamesForSummary.join(", ");
        const locStr = [...locSet].join(", ");

        const anotherGroups = {};
        cardRows.forEach(r => {
            const another = String(r[5] || "").trim();
            const displayAnother = another === "" ? "기본" : another; 
            if(!anotherGroups[displayAnother]) anotherGroups[displayAnother] = [];
            anotherGroups[displayAnother].push(r);
        });

        let leftTableHtml = `<table class="split-table"><thead><tr><th class="fp-col-1">일러스트</th><th class="fp-col-2">보관 위치</th><th class="fp-col-3">총 수량</th></tr></thead><tbody>`;
        let rightTableHtml = `<table class="split-table"><thead><tr>`;
        
        distinctKeys.forEach(key => {
             const info = rarityLookup[key];
             let displayName = key;
             let tooltipContent = key;

             if (info) {
                 displayName = info.data.display || key;
                 tooltipContent = info.data[currentRegion] || key;
             }
             
             tooltipContent = tooltipContent.replace(/\(/g, '<br>(');
             
             rightTableHtml += `<th class="sp-col tooltipped" data-position="top" data-tooltip="${tooltipContent}">${displayName}</th>`;
        });
        rightTableHtml += `</tr></thead><tbody>`;

        const anotherKeys = Object.keys(anotherGroups).sort((a, b) => {
            if (a === "기본") return -1;
            if (b === "기본") return 1;
            return a.localeCompare(b, undefined, { numeric: true });
        });

        anotherKeys.forEach(another => {
             const grpRows = anotherGroups[another];
             const locGroups = {};
             grpRows.forEach(r => {
                 const loc = String(r[4]);
                 const proc = String(r[2]);
                 const qty = parseInt(r[3]) || 0;
                 if(!locGroups[loc]) locGroups[loc] = { total: 0, procs: {} };
                 locGroups[loc].total += qty;
                 locGroups[loc].procs[proc] = (locGroups[loc].procs[proc] || 0) + qty;
             });

             const locKeys = Object.keys(locGroups);
             locKeys.forEach((loc, idx) => {
                 const d = locGroups[loc];
                 
                 leftTableHtml += `<tr>`;
                 if(idx === 0) leftTableHtml += `<td rowspan="${locKeys.length}">${another}</td>`;
                 leftTableHtml += `<td>${loc}</td><td>${d.total}</td></tr>`;

                 rightTableHtml += `<tr>`;
                 distinctKeys.forEach(key => {
                     const val = d.procs[key] || 0;
                     rightTableHtml += `<td>${val}</td>`;
                 });
                 rightTableHtml += `</tr>`;
             });
        });
        
        leftTableHtml += `</tbody></table>`;
        rightTableHtml += `</tbody></table>`;

        newHtml += `
            <div class="new-card-box">
                <div class="summary-split-wrapper">
                    <div class="summary-left">${cardNo}</div>
                    <div class="summary-right">
                        <table class="summary-table">
                            <tr>
                                <td class="summary-label-cell">보관 위치</td>
                                <td class="summary-label-cell">수량</td>
                            </tr>
                            <tr>
                                <td class="summary-value-cell">${locStr}</td>
                                <td class="summary-value-cell">${totalQty}</td>
                            </tr>
                            <tr>
                                <td class="summary-label-cell border-double-top">보유 레어도</td>
                                <td class="summary-value-cell border-double-top">${procStr}</td>
                            </tr>
                        </table>
                    </div>
                </div>
                <div id="detail-${rowId}" class="detail-slide-wrapper">
                    <div class="split-table-wrapper">
                        <div class="fixed-side">${leftTableHtml}</div>
                        <div class="scroll-side">${rightTableHtml}</div>
                    </div>
                </div>
                <button class="show-more-btn" onclick="toggleNewDetail('detail-${rowId}')">
                    <span>자세히 보기</span>
                    <i class="material-icons tiny">keyboard_arrow_down</i>
                </button>
            </div>
        `;
    });

    resultArea.innerHTML = newHtml;
    M.Tooltip.init(resultArea.querySelectorAll('.tooltipped'), {
        html: true,
        margin: 3
    });
    setTimeout(() => resultArea.classList.add('show'), 50);
  }

  function toggleNewDetail(detailId) {
      const content = document.getElementById(detailId);
      const btn = content.nextElementSibling; 
      const textSpan = btn.querySelector('span');
      const icon = btn.querySelector('i');
      
      if (content.style.maxHeight) {
          content.style.maxHeight = null;
          textSpan.innerText = '자세히 보기';
          icon.innerText = 'keyboard_arrow_down';
      } else {
          content.style.maxHeight = content.scrollHeight + "px";
          textSpan.innerText = '간략히 보기';
          icon.innerText = 'keyboard_arrow_up';
      }
  }

  function toggleAnother(rowId) {
  }

  // Manage functions
  function addManageRows(count = null) { const tbody = document.getElementById('manage-card-tbody'); let increment = count || ((tbody.children.length === 1) ? 4 : 5); let startIdx = tbody.children.length + 1; for (let i = 0; i < increment; i++) { const row = document.createElement('tr'); row.innerHTML = `<td>${startIdx + i}</td><td><span class="card-name-fetch">카드 번호를 입력해주세요.</span></td><td><input type="text" class="manage-card-no" onblur="updateManageDropdowns(this)" placeholder="번호 입력"></td><td><select class="browser-default manage-another flex-select" onchange="updateManageProcessing(this)" disabled><option value="">선택</option></select></td><td><select class="browser-default manage-proc flex-select" onchange="updateManageStorage(this)" disabled><option value="">선택</option></select></td><td><select class="browser-default manage-loc flex-select" onchange="updateManageMoveLoc(this)" disabled><option value="">선택</option></select></td><td><div class="td-flex-container"><select class="browser-default move-loc flex-select" onchange="syncDirectInputManage(this)" disabled><option value="" disabled selected>선택</option></select><input type="text" class="direct-input loc-direct flex-input" placeholder="새 위치"></div></td><td><span class="storage-qty-disp">-</span></td><td><input type="number" class="move-qty" min="1" disabled style="height:2.2rem !important; text-align:center;"></td>`; tbody.appendChild(row); } }
  function updateManageDropdowns(inputEl) { const row = inputEl.closest('tr'); const cardNo = inputEl.value.trim().toUpperCase(); inputEl.value = cardNo; const nameSpan = row.querySelector('.card-name-fetch'); resetManageRow(row, 'another'); if (!cardNo) { nameSpan.innerText = "카드 번호를 입력해주세요."; return; } const matches = localCardDatabase.filter(r => String(r[1]).toUpperCase() === cardNo); if (matches.length > 0) { nameSpan.innerText = matches[0][0]; const anotherSel = row.querySelector('.manage-another'); const anothers = [...new Set(matches.map(r => r[5] || ""))]; if (anothers.length === 1 && anothers[0] === "") { anotherSel.innerHTML = `<option value="" selected>기본</option>`; anotherSel.value = ""; anotherSel.disabled = true; updateManageProcessing(anotherSel); } else { anotherSel.innerHTML = `<option value="__placeholder__" disabled selected>선택</option>` + (anothers.includes("") ? `<option value="">기본</option>` : '') + anothers.filter(a => a !== "").map(a => `<option value="${a}">${a}</option>`).join(''); anotherSel.disabled = false; } } else { nameSpan.innerText = "보유하지 않은 카드"; } }
  
  // [NEW] updateManageProcessing: 카드 이동 모달의 레어도 목록에도 현지화 적용
  function updateManageProcessing(anotherEl) { 
      const row = anotherEl.closest('tr'); 
      if (anotherEl.value === "__placeholder__") return; 
      resetManageRow(row, 'proc'); 
      const cardNo = row.querySelector('.manage-card-no').value.trim().toUpperCase(); 
      const another = anotherEl.value; 
      const matches = localCardDatabase.filter(r => String(r[1]).toUpperCase() === cardNo && String(r[5] || "").trim() === String(another).trim()); 
      const procSel = row.querySelector('.manage-proc'); 
      const procs = [...new Set(matches.map(r => r[2]))]; 
      // getLocalizedRarity 적용
      procSel.innerHTML = `<option value="" disabled selected>선택</option>` + 
                          procs.map(p => `<option value="${p}">${getLocalizedRarity(p)}</option>`).join(''); 
      procSel.disabled = false; 
  }

  function updateManageStorage(procEl) { const row = procEl.closest('tr'); resetManageRow(row, 'storage'); const cardNo = row.querySelector('.manage-card-no').value.trim().toUpperCase(); const another = row.querySelector('.manage-another').value; const proc = procEl.value; const matches = localCardDatabase.filter(r => String(r[1]).toUpperCase() === cardNo && String(r[5] || "").trim() === String(another).trim() && String(r[2]).trim() === String(proc).trim()); const storageSel = row.querySelector('.manage-loc'); const locs = [...new Set(matches.map(r => r[4]))]; storageSel.innerHTML = `<option value="" disabled selected>선택</option>` + locs.map(l => `<option value="${l}">${l}</option>`).join(''); storageSel.disabled = false; }
  function updateManageMoveLoc(locEl) { const row = locEl.closest('tr'); resetManageRow(row, 'move'); const cardNo = row.querySelector('.manage-card-no').value.trim().toUpperCase(); const another = row.querySelector('.manage-another').value; const proc = row.querySelector('.manage-proc').value; const currentLoc = locEl.value; const matches = localCardDatabase.filter(r => String(r[1]).toUpperCase() === cardNo && String(r[5] || "").trim() === String(another).trim() && String(r[2]).trim() === String(proc).trim() && String(r[4]).trim() === String(currentLoc).trim()); const totalQty = matches.reduce((sum, r) => sum + (parseInt(r[3]) || 0), 0); row.querySelector('.storage-qty-disp').innerText = totalQty; const moveSel = row.querySelector('.move-loc'); const availableLocs = allLocations.filter(l => l !== currentLoc); moveSel.innerHTML = `<option value="" disabled selected>선택</option>` + availableLocs.map(l => `<option value="${l}">${l}</option>`).join('') + `<option value="DIRECT">직접 입력</option>`; moveSel.disabled = false; }
  function syncDirectInputManage(sel) { const row = sel.closest('tr'); const input = sel.nextElementSibling; const qtyInput = row.querySelector('.move-qty'); const maxQty = parseInt(row.querySelector('.storage-qty-disp').innerText); if (sel.value === 'DIRECT') { sel.style.flex = "0 0 35%"; input.style.display = 'block'; input.style.flex = "1"; input.disabled = false; input.value = ""; input.focus(); } else { sel.style.flex = "1"; input.style.display = 'none'; input.disabled = true; input.value = sel.value; } qtyInput.disabled = false; qtyInput.max = maxQty; 
    qtyInput.placeholder = ""; 
    qtyInput.value = ""; 
  }
  function resetManageRow(row, level) { const levels = ['another', 'proc', 'storage', 'move']; const startIdx = levels.indexOf(level); if (startIdx <= 0) { const el = row.querySelector('.manage-another'); el.innerHTML = '<option value="">선택</option>'; el.disabled = true; } if (startIdx <= 1) { const el = row.querySelector('.manage-proc'); el.innerHTML = '<option value="">선택</option>'; el.disabled = true; } if (startIdx <= 2) { const el = row.querySelector('.manage-loc'); el.innerHTML = '<option value="">선택</option>'; el.disabled = true; } if (startIdx <= 3) { const moveSel = row.querySelector('.move-loc'); moveSel.innerHTML = '<option value="">선택</option>'; moveSel.disabled = true; moveSel.style.flex = "1"; const directInp = row.querySelector('.loc-direct'); directInp.style.display = 'none'; directInp.value = ""; row.querySelector('.storage-qty-disp').innerText = "-"; const qtyInp = row.querySelector('.move-qty'); qtyInp.value = ""; qtyInp.disabled = true; qtyInp.placeholder = ""; } }
  async function submitManageCards() { const tbody = document.getElementById('manage-card-tbody'); const moves = []; for (let tr of tbody.children) { const cardName = tr.querySelector('.card-name-fetch').innerText; const cardNo = tr.querySelector('.manage-card-no').value.trim(); if (!cardNo || cardName === "카드 번호를 입력해주세요." || cardName === "보유하지 않은 카드") continue; const another = tr.querySelector('.manage-another').value; const proc = tr.querySelector('.manage-proc').value; const currentLoc = tr.querySelector('.manage-loc').value; const moveSel = tr.querySelector('.move-loc'); let targetLoc = moveSel.value === 'DIRECT' ? tr.querySelector('.loc-direct').value.trim() : moveSel.value; const moveQty = parseInt(tr.querySelector('.move-qty').value); const maxQty = parseInt(tr.querySelector('.storage-qty-disp').innerText); if (another !== "__placeholder__" && proc && currentLoc && targetLoc && moveQty > 0 && moveQty <= maxQty) { moves.push({ cardName, cardNo, another, proc, currentLoc, targetLoc, moveQty }); } } if (moves.length === 0) { M.toast({html: '유효한 이동 요청이 없습니다.', classes: 'red darken-2 rounded'}); return; } const btn = document.getElementById('manage-submit-btn'); btn.classList.add('disabled'); showLoading(true, "이동 처리 중..."); try { const res = await callApi('moveCards', {}, moves); M.Modal.getInstance(document.getElementById('manage-card-modal')).close(); showLoading(false); M.toast({html: '카드 이동 완료!', displayLength: 1500, classes: 'cyan darken-2'}); setTimeout(() => location.reload(), 1500); } catch (e) { showLoading(false); btn.classList.remove('disabled'); M.toast({html: '처리 중 오류 발생', classes: 'red darken-2 rounded'}); } }

  // Add Card Logic
  function addMoreRows(count = null) {
    const tbody = document.getElementById('add-card-tbody');
    let startIdx = tbody.children.length + 1;
    const currentCount = tbody.children.length;
    let increment = 0;
    
    if (count !== null) increment = count;
    else if (currentCount === 0) increment = 5;
    else {
        const remainder = currentCount % 5;
        increment = (remainder === 0) ? 5 : (5 - remainder);
    }

    for (let i = 0; i < increment; i++) {
      const row = document.createElement('tr');
      // [NEW] 레어도 선택지 생성 시 getLocalizedRarity 적용
      row.innerHTML = `
        <td style="font-weight:600; color:#888;">${startIdx + i}</td>
        <td><span class="card-name-fetch">카드 번호를 입력해주세요.</span></td>
        <td><input type="text" class="new-card-no" onblur="fetchCardName(this)" placeholder="번호 입력"></td>
        <td>
            <div class="another-cell-container">
                <select class="browser-default new-card-another flex-select" disabled onchange="updateRowState(this.closest('tr'))">
                    <option value="" selected>기본</option>
                </select>
            </div>
        </td>
        <td>
            <select class="browser-default new-card-proc flex-select" disabled onchange="updateRowState(this.closest('tr'))">
                <option value="" disabled selected>선택</option>
                ${allProcessingTypes.map(p => `<option value="${p}">${getLocalizedRarity(p)}</option>`).join('')}
            </select>
        </td>
        <td>
            <div class="td-flex-container">
                <select class="browser-default new-card-loc flex-select" onchange="syncDirectInput(this)" disabled>
                    <option value="" disabled selected>선택</option>
                    ${allLocations.map(l => `<option value="${l}">${l}</option>`).join('')}
                    <option value="DIRECT">위치 추가</option>
                </select>
                <input type="text" class="direct-input loc-direct flex-input" oninput="updateRowState(this.closest('tr'))" disabled>
            </div>
        </td>
        <td><input type="number" class="new-card-qty" min="1" value="1" disabled onchange="checkAddButton()"></td>
        <td>
            <div class="adjust-btn-group">
                <span class="adjust-btn plus tooltipped disabled" data-position="top" data-tooltip="복사" onclick="copyRow(this)">+</span>
                <span class="adjust-btn minus tooltipped disabled" data-position="top" data-tooltip="행 삭제" onclick="deleteRow(this)">-</span>
            </div>
        </td>
      `;
      tbody.appendChild(row);
    }
    M.Tooltip.init(tbody.querySelectorAll('.tooltipped'));
    checkAddButton(); 
  }

  function syncDirectInput(sel) { 
    const input = sel.nextElementSibling; 
    const row = sel.closest('tr');
    
    if (sel.value === 'DIRECT') { 
        sel.style.flex = "0 0 35%"; 
        input.style.display = 'block'; 
        input.style.flex = "1"; 
        input.disabled = false; 
        input.value = ""; 
        input.focus(); 
    } else { 
        sel.style.flex = "1"; 
        input.style.display = 'none'; 
        input.disabled = true; 
        input.value = sel.value; 
    } 
    updateRowState(row);
  }

  function updateRowState(row) {
    const name = row.querySelector('.card-name-fetch').innerText;
    const anotherSel = row.querySelector('.new-card-another');
    const procSel = row.querySelector('.new-card-proc');
    const locSel = row.querySelector('.new-card-loc');
    const locDirect = row.querySelector('.loc-direct');
    const qtyInput = row.querySelector('.new-card-qty');

    const isNameValid = !name.includes("입력해주세요") && !name.includes("오류") && !name.includes("조회 중") && !name.includes("확인하세요");
    
    let isAnotherSelected = false;
    if(anotherSel.selectedOptions.length > 0) {
        if (!anotherSel.selectedOptions[0].disabled) isAnotherSelected = true;
    } else {
        if(anotherSel.value !== "" && anotherSel.value !== null) isAnotherSelected = true;
        else if(anotherSel.value === "" && !anotherSel.disabled) isAnotherSelected = true;
    }

    if (isNameValid && isAnotherSelected) {
        procSel.disabled = false;
    } else {
        procSel.disabled = true;
        procSel.value = "";
    }

    if (!procSel.disabled && procSel.value) {
        locSel.disabled = false;
    } else {
        locSel.disabled = true;
        locSel.value = "";
        locDirect.style.display = 'none';
        locSel.style.flex = "1";
    }

    let isLocValid = false;
    if (!locSel.disabled) {
        if (locSel.value === 'DIRECT') {
            isLocValid = locDirect.value.trim().length > 0;
        } else {
            isLocValid = locSel.value !== "" && locSel.value !== null;
        }
    }

    if (isLocValid) {
        qtyInput.disabled = false;
    } else {
        qtyInput.disabled = true;
    }

    checkAddButton();
  }

  function updateDisconnectBtn() { const btn = document.getElementById('disconnect-btn'); if (localStorage.getItem(STORAGE_KEY)) btn.classList.remove('disabled'); else btn.classList.add('disabled'); }
  function toggleGuide(forceOpen = null) { 
      const btn = document.getElementById('guide-accordion-btn'); 
      const box = document.getElementById('guide-box'); 
      const isOpen = (forceOpen !== null) ? forceOpen : box.style.display === 'none'; 
      box.style.display = isOpen ? 'block' : 'none'; 
      if (isOpen) btn.classList.add('active'); else btn.classList.remove('active'); 
  }
  function openGuideFromMain() { M.Modal.getInstance(document.getElementById('settings-modal')).open(); toggleGuide(true); }
  
  function setCardNameHtml(span, name) {
    if (nameDb[name]) {
        const { id, locale } = nameDb[name];
        const url = `https://www.db.yugioh-card.com${id}&request_locale=${locale}`;
        span.innerHTML = `<a href="${url}" target="_blank" style="color:inherit; text-decoration:underline; cursor:pointer;">${name}</a>`;
    } else {
        span.innerText = name;
    }
  }

  async function fetchCardName(el) { 
    const row = el.closest('tr'); 
    el.value = el.value.toUpperCase();
    const cardNo = el.value.trim(); 
    
    const reqId = Date.now();
    el.dataset.reqId = reqId;

    const nameSpan = row.querySelector('.card-name-fetch'); 
    const procSel = row.querySelector('.new-card-proc');
    const locSel = row.querySelector('.new-card-loc');
    const qtyInput = row.querySelector('.new-card-qty');
    const anotherSel = row.querySelector('.new-card-another');
    
    procSel.innerHTML = `<option value="" disabled selected>선택</option>${allProcessingTypes.map(p => `<option value="${p}">${getLocalizedRarity(p)}</option>`).join('')}`;
    procSel.disabled = true;
    locSel.disabled = true;
    qtyInput.disabled = true;
    anotherSel.disabled = true;
    
    if (!cardNo) { 
        nameSpan.innerText = "카드 번호를 입력해주세요."; 
        checkAddButton(); 
        return; 
    }
    
    if (clientCache[cardNo]) {
        const cached = clientCache[cardNo];
        setCardNameHtml(nameSpan, cached.name);
        applyCardDataToRow(cached, row);
        updateRowState(row);
        return;
    }

    nameSpan.innerText = "조회 중..."; 
    try { 
      const res = await callApi('getCardNameFromDb', { cardNo }); 
      
      if (el.dataset.reqId != reqId) return;

      if (res.name === "유효하지 않은 카드 번호" || res.name === "접속 오류" || res.name === "카드 번호를 확인하세요!" || res.name === "결과 없음" || res.name.includes("오류")) {
        nameSpan.innerText = res.name;
      } else {
        clientCache[cardNo] = { name: res.name, anotherCount: res.anotherCount, rarities: res.rarities };
        if (res.linkData) {
            nameDb[res.name] = res.linkData;
        }
        setCardNameHtml(nameSpan, res.name);
        applyCardDataToRow(res, row);
      }
    } catch (e) { 
        if (el.dataset.reqId == reqId) nameSpan.innerText = "접속 오류"; 
    } 
    updateRowState(row);
  }

  function applyCardDataToRow(data, row) {
    const procSel = row.querySelector('.new-card-proc');
    const anotherSel = row.querySelector('.new-card-another');

    const count = data.anotherCount || 1; 
    let optionsHtml = '';

    if (count > 1) {
        optionsHtml += `<option value="" disabled selected>선택</option>`;
        optionsHtml += `<option value="">기본</option>`; 
        for(let i=2; i<=count; i++) {
            let suffix = "th";
            if(i===2) suffix="nd";
            if(i===3) suffix="rd";
            optionsHtml += `<option value="${i}${suffix}">${i}${suffix}</option>`;
        }
        anotherSel.disabled = false;
    } else {
        optionsHtml += `<option value="" selected>기본</option>`;
        anotherSel.disabled = true;
    }
    anotherSel.innerHTML = optionsHtml;

    if (!data.isFallback && data.rarities && data.rarities.length > 0) {
        // [NEW] 레어도 선택지 생성 시 getLocalizedRarity 적용
        procSel.innerHTML = `<option value="" disabled selected>보유 레어도 선택</option>` + 
                            data.rarities.map(r => `<option value="${r}">${getLocalizedRarity(r)}</option>`).join('');
    }
  }

  function copyRow(btn) {
    if(btn.classList.contains('disabled')) return;
    const currentRow = btn.closest('tr');
    const newRow = currentRow.cloneNode(true);
    
    newRow.querySelector('.new-card-no').value = currentRow.querySelector('.new-card-no').value;
    
    const nameSpan = currentRow.querySelector('.card-name-fetch');
    newRow.querySelector('.card-name-fetch').innerHTML = nameSpan.innerHTML;
    
    newRow.querySelector('.new-card-another').innerHTML = currentRow.querySelector('.new-card-another').innerHTML;
    newRow.querySelector('.new-card-another').value = currentRow.querySelector('.new-card-another').value;
    newRow.querySelector('.new-card-another').disabled = currentRow.querySelector('.new-card-another').disabled;

    newRow.querySelector('.new-card-proc').innerHTML = currentRow.querySelector('.new-card-proc').innerHTML;
    newRow.querySelector('.new-card-proc').value = currentRow.querySelector('.new-card-proc').value;
    newRow.querySelector('.new-card-proc').disabled = currentRow.querySelector('.new-card-proc').disabled;

    newRow.querySelector('.new-card-loc').value = currentRow.querySelector('.new-card-loc').value;
    newRow.querySelector('.new-card-loc').disabled = currentRow.querySelector('.new-card-loc').disabled;
    
    const directInput = currentRow.querySelector('.loc-direct');
    const newDirectInput = newRow.querySelector('.loc-direct');
    if (directInput.style.display !== 'none') {
        newDirectInput.style.display = 'block';
        newDirectInput.value = directInput.value;
        newDirectInput.disabled = false;
        newRow.querySelector('.new-card-loc').style.flex = "0 0 35%";
        newDirectInput.style.flex = "1";
    }

    newRow.querySelector('.new-card-qty').value = currentRow.querySelector('.new-card-qty').value;
    newRow.querySelector('.new-card-qty').disabled = currentRow.querySelector('.new-card-qty').disabled;

    currentRow.after(newRow);
    M.Tooltip.init(newRow.querySelectorAll('.tooltipped'));
    reIndexRows();
    updateRowState(newRow);
  }

  function deleteRow(btn) {
    if(btn.classList.contains('disabled')) return;
    const row = btn.closest('tr');
    const tooltipInstance = M.Tooltip.getInstance(btn);
    if(tooltipInstance) tooltipInstance.destroy();
    row.remove();
    reIndexRows();
    checkAddButton();
  }

  function reIndexRows() {
    const rows = document.querySelectorAll('#add-card-tbody tr');
    rows.forEach((row, index) => {
        row.cells[0].innerText = index + 1;
    });
  }

  function checkAddButton() {
    const tbody = document.getElementById('add-card-tbody');
    const rows = tbody.querySelectorAll('tr');
    let globalValid = false;
    const totalRows = rows.length;

    rows.forEach(tr => {
        const name = tr.querySelector('.card-name-fetch').innerText;
        const proc = tr.querySelector('.new-card-proc').value;
        const locSel = tr.querySelector('.new-card-loc');
        let loc = locSel.value;
        
        if (loc === 'DIRECT') {
            const directInput = tr.querySelector('.loc-direct').value.trim();
            if (!directInput) loc = ""; 
        }

        const isValidRow = (!name.includes("입력해주세요") && !name.includes("확인하세요") && !name.includes("유효하지 않은") && !name.includes("오류") && !name.includes("조회 중") && proc && loc);
        
        if (isValidRow) globalValid = true;

        const plusBtn = tr.querySelector('.adjust-btn.plus');
        const minusBtn = tr.querySelector('.adjust-btn.minus');

        if(isValidRow) plusBtn.classList.remove('disabled');
        else plusBtn.classList.add('disabled');

        if(totalRows > 1) minusBtn.classList.remove('disabled');
        else minusBtn.classList.add('disabled');
    });

    const btn = document.getElementById('add-submit-btn');
    const wrapper = document.querySelector('.tooltipped-wrapper');
    if (globalValid) {
        btn.classList.remove('disabled');
        M.Tooltip.getInstance(wrapper).destroy(); 
    } else {
        btn.classList.add('disabled');
        M.Tooltip.init(wrapper, {html: "등록할 수 있는 카드가 없습니다.", position: "top"});
    }
  }

  async function submitNewCards() {
    const tbody = document.getElementById('add-card-tbody'); 
    const validRows = [];
    const detailLog = []; 
    let successCount = 0;
    let successQty = 0;

    for (let tr of tbody.children) {
      const no = tr.cells[0].innerText;
      const cardNo = tr.querySelector('.new-card-no').value.trim(); 
      let name = tr.querySelector('.card-name-fetch').innerText;
      if (!cardNo) continue;

      let another = tr.querySelector('.new-card-another').value.trim();
      let proc = tr.querySelector('.new-card-proc').value;
      let loc = tr.querySelector('.new-card-loc').value === 'DIRECT' ? tr.querySelector('.loc-direct').value.trim() : tr.querySelector('.new-card-loc').value;
      const qty = parseInt(tr.querySelector('.new-card-qty').value);

      let failReason = null;
      if (name.includes("유효하지 않은") || name.includes("확인하세요") || name.includes("결과 없음")) { failReason = "invalid_no"; name = "유효하지 않은 카드 번호"; }
      else if (name.includes("조회 중") || name.includes("오류")) { failReason = "error"; name = "조회 오류"; }
      else if (!proc) { failReason = "no_proc"; proc = "미선택"; }
      else if (!loc) { failReason = "no_loc"; loc = "미선택"; }

      if (failReason) {
        detailLog.push({ no, name, cardNo, another, proc, loc, qty, status: 'fail', failReason });
        tr.dataset.status = 'fail';
      } else {
        validRows.push([name, cardNo, proc, qty, loc, another]);
        detailLog.push({ no, name, cardNo, another, proc, loc, qty, status: 'success' });
        successCount++;
        successQty += qty;
        tr.dataset.status = 'success';
      }
    }

    if (validRows.length > 0) {
        const btn = document.getElementById('add-submit-btn'); 
        btn.classList.add('disabled'); 
        showLoading(true, "기록 중...");

        try {
          await callApi('addCards', {}, validRows); 
          showLoading(false); 
          showResultModal(successCount, successQty, detailLog);
        } catch (e) { 
            showLoading(false); 
            btn.classList.remove('disabled');
            M.toast({html: '서버 통신 오류', classes: 'red darken-2 rounded'}); 
        }
    } else {
        showResultModal(0, 0, detailLog);
    }
  }

  function showResultModal(count, totalQty, detailLog) {
    const modal = M.Modal.getInstance(document.getElementById('add-result-modal'));
    document.getElementById('result-success-text').innerText = `${count}종의 카드 ${totalQty}장을 등록했습니다.`;
    const failCount = detailLog.filter(l => l.status === 'fail').length;
    document.getElementById('result-fail-text').innerText = failCount > 0 ? `(${failCount}종의 카드를 등록할 수 없습니다.)` : "";
    
    hasRegisteredInSession = true;

    let summaryHtml = "";
    const successLogs = detailLog.filter(l => l.status === 'success');
    if (successLogs.length > 0) {
        const aggregated = {};
        successLogs.forEach(l => {
            const name = l.name; const no = l.cardNo; const q = l.qty;
            if(!aggregated[name]) aggregated[name] = {};
            if(!aggregated[name][no]) aggregated[name][no] = 0;
            aggregated[name][no] += q;
        });

        Object.keys(aggregated).forEach(name => {
            const numbers = Object.keys(aggregated[name]);
            numbers.forEach((no, idx) => {
                summaryHtml += `<tr class="success-row">`;
                if(idx === 0) summaryHtml += `<td rowspan="${numbers.length}">${name}</td>`;
                summaryHtml += `<td>${no}</td><td>${aggregated[name][no]}장</td></tr>`;
            });
        });
    }
    
    const failLogs = detailLog.filter(l => l.status === 'fail');
    if (failLogs.length > 0) {
        failLogs.forEach((l) => {
            let reason = l.name; 
            if(l.failReason === "no_proc" || l.failReason === "no_loc") reason = `${l.failReason === "no_proc" ? "레어도" : "보관 위치"} 미선택`;
            else if(l.failReason === "invalid_no") reason = "존재하지 않은 카드 번호";
            
            summaryHtml += `<tr class="fail-row">`;
            summaryHtml += `<td style="color:var(--error-red);">${reason}</td><td>${l.cardNo}</td><td>-</td></tr>`;
        });
    }
    document.getElementById('result-summary-body').innerHTML = summaryHtml;

    let detailHtml = detailLog.map(l => {
        const rowClass = l.status === 'success' ? 'success-row' : 'fail-row';
        return `<tr class="${rowClass}">
            <td>${l.no}</td>
            <td style="${l.status==='fail' && (l.failReason==='invalid_no' || l.failReason==='error') ? 'color:var(--error-red); font-weight:700;' : ''}">${l.name}</td>
            <td>${l.cardNo}</td>
            <td>${l.another || '-'}</td>
            <td style="${l.status==='fail' && l.failReason==='no_proc' ? 'color:var(--error-red); font-weight:700;' : ''}">${l.proc}</td>
            <td style="${l.status==='fail' && l.failReason==='no_loc' ? 'color:var(--error-red); font-weight:700;' : ''}">${l.loc}</td>
            <td>${l.qty}</td>
        </tr>`;
    }).join('');
    document.getElementById('result-detail-body').innerHTML = detailHtml;

    document.getElementById('result-detail-box').style.display = 'none';
    document.getElementById('toggle-icon').innerText = 'keyboard_arrow_down';
    modal.open();
  }

  function toggleResultDetail() {
    const box = document.getElementById('result-detail-box');
    const icon = document.getElementById('toggle-icon');
    const isHidden = box.style.display === 'none';
    box.style.display = isHidden ? 'block' : 'none';
    icon.innerText = isHidden ? 'keyboard_arrow_up' : 'keyboard_arrow_down';
  }

  function handleContinueRegistration() {
    // Result Modal 닫기 (이 동작은 onCloseEnd 이벤트를 트리거하지만, 거기서 add-result-modal 체크를 뺐으므로 새로고침 안됨)
    M.Modal.getInstance(document.getElementById('add-result-modal')).close();
    
    // add-card-tbody 행 정리 (성공한 행 제거, 실패한 행 유지)
    const tbody = document.getElementById('add-card-tbody');
    let hasFailures = false;
    Array.from(tbody.children).forEach(tr => {
        if (tr.dataset.status === 'success') {
            tr.remove(); 
        } else {
            hasFailures = true; 
            delete tr.dataset.status;
        }
    });
    
    if (!hasFailures) {
        addMoreRows(1);
    } else {
        reIndexRows();
        const currentCount = tbody.children.length;
        const remainder = currentCount % 5;
        if (remainder !== 0) {
            addMoreRows(5 - remainder);
        }
    }
    
    document.getElementById('add-card-modal').dataset.keepData = "true";
    
    // Add Card Modal이 혹시 닫혀있다면 다시 엽니다.
    const addCardModal = M.Modal.getInstance(document.getElementById('add-card-modal'));
    if (!addCardModal.isOpen) {
        addCardModal.open();
    }
  }

  function saveSettings() { const url = document.getElementById('sheet-url').value; const match = url.match(/[-\w]{25,}/); if (match) { localStorage.setItem(STORAGE_KEY, match[0]); location.reload(); } }
  function disconnectSheet() { localStorage.removeItem(STORAGE_KEY); location.reload(); }
  
  function saveRecentSearch(name) { let recent = JSON.parse(localStorage.getItem(RECENT_KEY) || '[]'); recent = [name, ...recent.filter(n => n !== name)].slice(0, 5); localStorage.setItem(RECENT_KEY, JSON.stringify(recent)); }
  function clearAllHistory() { localStorage.removeItem(RECENT_KEY); } 
  
  function quickSearch(name) { document.getElementById('card-search').value = name; startSearch(); }
  function showLoading(show, text) { document.getElementById('loading-overlay').style.display = show ? 'flex' : 'none'; document.getElementById('loading-text').innerText = text; }
</script>
</body>
</html>```
